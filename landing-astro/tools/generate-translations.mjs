import { readFileSync, writeFileSync } from 'node:fs';
import { join, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';
import { load } from 'cheerio';

const __filename = fileURLToPath(import.meta.url);
const __dirname = resolve(__filename, '..');

const projectRoot = resolve(__dirname, '..');
const outputPath = join(projectRoot, 'src', 'i18n', 'translations.ts');
const sourceFiles = [
  'index.html',
  'works.html',
  'privacy-policy.html',
  'terms-of-service.html',
];

/** @type {Record<string, { en: string; ar: string }>} */
const translations = {};

const addTranslation = (key, enValue, arValue) => {
  if (!enValue || !arValue) return;
  const trimmedKey = key.trim();
  if (!trimmedKey) return;
  translations[trimmedKey] = {
    en: enValue.trim(),
    ar: arValue.trim(),
  };
};

for (const fileName of sourceFiles) {
  const legacyHtmlPath = resolve(projectRoot, '..', fileName);
  const htmlContent = readFileSync(legacyHtmlPath, 'utf8');
  const $ = load(htmlContent);

  $('[data-en][data-ar]').each((_idx, element) => {
    const en = $(element).attr('data-en');
    const ar = $(element).attr('data-ar');
    if (!en || !ar) return;
    addTranslation(en, en, ar);
  });

  $('[data-placeholder-en][data-placeholder-ar]').each((_idx, element) => {
    const en = $(element).attr('data-placeholder-en');
    const ar = $(element).attr('data-placeholder-ar');
    if (!en || !ar) return;
    addTranslation(`placeholder::${en}`, en, ar);
  });
}

const fileHeader = `/* eslint-disable */\n// This file is auto-generated by tools/generate-translations.mjs\n// Do not edit manually. Update the source HTML and re-run the generator.\n\n`;

const typeDeclarations = `export type SupportedLocale = 'en' | 'ar';\nexport interface TranslationEntry { en: string; ar: string; }\n\n`;

const table = JSON.stringify(translations, null, 2);

const fileBody = `export const translations: Record<string, TranslationEntry> = ${table} as const;\n`;

writeFileSync(outputPath, `${fileHeader}${typeDeclarations}${fileBody}`, 'utf8');

console.log(
  `Generated ${Object.keys(translations).length} translation entries to ${outputPath}`,
);

